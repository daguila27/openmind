

<%if(login_admin){%>
  <%- include layouts/admin_header.ejs %>
<%}
else{%>
  <%- include layouts/user_header.ejs%>
<%}%>
<style type="text/css">
  .list-group-item:hover {
    background-color: #f5f5f5;
  }
  .panelitem{
        width:33%;
        text-align: center;
    }
</style>



<div class="modal fade" id="quitar-saldo" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span  aria-hidden="true">&times;</span></button>
          <h4 class="modal-title">Quitar saldo: </h4>
        </div>
            
        <div class="modal-body">
                <div class="input-group">
                  <span class="input-group-addon">$</span>
                  <input id="monto-menos" type="number" class="form-control" placeholder="Ingrese monto">
                </div>     
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary men-saldo" data-dismiss="modal">Enviar</button>
        </div><!-- /.modal -->
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<h1 class="page-header">Informe de ventas diario:</h1>
 
<div class="row">
        <div class="col-md-10 col-md-offset-1">
            <form method='post' action="/cerrar_turno">
              <input type="hidden" name="idcaja" id="idcaja" value="<%=caja.idcaja%>">
              <input type="hidden" id="caja-inicial" name="inicial" value="<%=caja.monto%>">
              <input type="hidden" id="caja-final" name="final">
              <div class="panel panel-danger">
                  <div class="panel-heading" style="display: flex;">
                      <h1 style="width: 80%">Turno: <%= caja.nombre%></h1>
                      <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#quitar-saldo">Quitar saldo</button>
                      <button type="submit" class="btn btn-success cerrar-turno">Cerrar Turno</button>
                  </div>
                  <div class="panel-body" style="display: flex;">
                      <div class="panelitem"><p><strong>Monto Inicial:</strong></p><p class="cash-inicial"  style="margin-top: 5px">$<%= caja.monto%></p></div>
                      <div class="panelitem"><p><strong>Diferencia: </strong></p><p class="cash" style="margin-top: 5px"></p></div>
                      <div class="panelitem"><p><strong>Monto Final: </strong></p><p class="cash-final" style="margin-top: 5px"></p></div>
                  </div>
              </div>
            </form>
        </div>
    </div>


  <div class="table-responsive">
      <table class="table table-striped table-bordered table-hover" >
              <tr id="head">
                <td><b>Detalle de producto</b></td>
                <td><b>Cantidad</b></td>
                <td><b>Precio Unitario</b></td>
                <td><b>Precio Final</b></td>
              </tr>
              <%for(var i=0; i < data.length; i++){%>
                <tr class="fila" id="fila<%=i%>">
                  <td><%= data[i].nombre%></td>
                  <td class="cant" data-cant="<%=data[i].total%>" ><%= data[i].total%></td>  
                  <td class="precio_u" data-precio="<%= data[i].precio_u%>">$<%= data[i].precio_u%></td>
                  <td class="precio_t"></td>
                </tr>
              <%}%> 
      </table>
  </div>
<!--<div class="row">
  <div class="col-md-10 col-md-offset-1 list-group">
    <div class="list-group-item">
      <p class="cash"></p>
    </div>
  </div>

</div>-->


<script type="text/javascript">
    function recalcular(monto, dif){

      $(".cash-inicial").html("$"+monto);
      $(".cash-final").html("$"+parseInt(monto + dif).toString());
    }
    var id;
    var cantidad;
    var precio_u;
    var monto_inicial = parseInt($("#caja-inicial").val());
    var caja_total = 0;
    $(".fila").each(function(){
      id = $(this).attr('id'); 
      cantidad = $("#"+id+" .cant").data('cant');
      precio_u = $("#"+id+" .precio_u").data('precio');
      $("#"+id+" .precio_t").html("$"+parseInt(cantidad*precio_u).toString());
      caja_total += (cantidad*precio_u);
    });
    $(".cash").html("$"+caja_total);
    $("#caja-final").val(parseInt(caja_total + monto_inicial));
    recalcular(monto_inicial, caja_total);
    

    $(".men-saldo").on('click', function(e){
        //e.preventDefault();
        $.ajax({
          type: 'POST',
          data: {idcaja: $("#idcaja").val(), monto: $("#monto-menos").val()},
          url: '/quitar_saldo',
          success: function(data){
            recalcular(parseInt(data), caja_total);
          }
        });
    });

</script>
<%- include layouts/footer.ejs %>